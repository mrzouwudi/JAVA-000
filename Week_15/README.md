# 作业说明
## Week15 作业题目：
## 周四作业：
1.（必做）针对课上讲解的内容，自己动手设计一个高并发的秒杀系统，讲架构图， 设计文档等，提交到 GitHub。

【一】从业务层面看，秒杀是一种营销手段，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。单纯的秒杀系统在业务层面上并不是或者说很难成为一个有盈利空间的交易方式，而是作为引流、品牌宣传、用户留存为目标的手段。

【二】从技术层面看秒杀系统会面对的问题：高并发读，高并发写，有效请求少（通常会是数量级上的差别），比较容易发生短时间会消耗大量资源（带宽，计算资源等），此外还经常伴随机器人和人工手工刷单等不利于商家行为的发生。因此完善秒杀系统需要具备以下几个特性：高性能、高可用、数据一致性、系统资源相对独立、良好的资源伸缩性、有效的风险控制。

高性能：秒杀涉及大量的并发读和并发写，因此支持高并发访问这点非常关键。

高可用：面对大量用户同时使用的交易系统（虽然实际成交量很低），高可用是十分重要的特性，而且必须有兜底方案（限流、服务降级等）

数据一致性：秒杀中商品减库存的需要尽可能地保证数据一致性

系统资源相对独立：因为秒杀活动具有不确定性，而且可能在极短时间处理大量请求，如果系统资源有关联和耦合会对目前的系统产生冲击。

良好的资源伸缩性：有一点需要说明，目前的秒杀系统应该是云部署的，应对有计划产生爆发式请求是可以以较低代价的快速进行网络资源和计算资源的堆加，以及秒杀结束后灵活地释放不必要的资源。

有效的风控：因为刷单以及恶意抢购者的存在，风控是很有必要的。当然初期可能只是避免简单一个用户同时刷多单的行为，但是如果秒杀活动持续进行，就需要不断完善分控体系。

【三】架构。整体架构如下：

![秒杀系统架构](https://github.com/mrzouwudi/JAVA-000/blob/main/Week_15/second_kill_arch_1.jpg)

整体架构，从左向右分别对应了在运营人员添加秒杀商品、秒杀前用户获取秒杀详情页、用户登录、秒杀下单以及支付和秒杀后运营获取秒杀结果进行分析的五个步骤。

运营人员通过秒杀商品后台管理系统添加商品并上架后，会直接将商品信息保存数据库中（上架只是修改了状态），同时在库存缓存中设置了初始库存，并且生成相应的静态页面存放到静态页面的缓存中，页面静态资源保存到OSS中。而在外网的CDN系统设置了相应的回源信息，这样可以进一步将静态页面和资源发布到CDN中。这里需要说明页面和库存缓存系统都是以Redis主从方式的，数据库同样采用了主从方式。

秒杀前用户获取秒杀详情页，直接从CDN中获取，这样将请求流量分散到CDN上，减轻了中央主站系统。此外，秒杀系统应该采用一个和主站不同的子域名，最好独立使用一个入口IP，这样进入流量和主站流量做区隔。如果初始和主站使用同一线路，则应限制秒杀系统域码访问带宽。

用户登录，访问用户系统进行用户登录。

秒杀页面中包含一个倒计时组件，倒计时结束后，进入秒杀请求页面，用户下单。这里可以设置一个验证环节，防止机器人刷单和降低用户的请求密度。如果但是用户体验可以设置一个特性开关，供线上灵活使用。用户下单的请求会通过一个验证模块，这个模块会快速过滤掉疑似机器人下单（明显低于验证环节用时）和同一用户多次下单（使用类似roaringbitmap的技术）以及将来自黑名单中IP和用户过滤掉。对于库存已为零后的请求也放弃，并回复给用户库存不足的信息。通过过滤模块的订单会推送到消息中间件（MQ）中，这里应使用二代的MQ，可以对消息进行堆积。秒杀订单系统从MQ中获取订单信息并进行减库存等操作，操作成功的订单会保存到订单数据库中并调用支付系统，订单系统会将所有处理的订单消息再退回到MQ中并且和之前的下单信息相关联。通知模块会获取相关信息（这里也包括支付系统推送到MQ中的信息），通知给用户。通知模块会将相关指标发生给数据收集系统。此外数据收集系统也会从APM、MQ和其他相关系统或模块获取（接收）相关信息，并且将和风险模块相关的信息发给风险模块，将运营数据发给运营指标收集系统。风险模块可以通过分析甄别初恶意用户或有风险的IP将其纳入黑名单。注：在左耳听风的专栏中提到可以通过CDN的边缘节点实现部分订单过滤方式。

秒杀后运营获取秒杀结果进行分析，运营人员通过运营指标收集系统分析秒杀活动的具体指标完成情况，以确认达成情况，作为复盘的参照事实和下次改进的依据。

【四】更深入的讨论
秒杀功能对于大部分电商实际是一个战术手段，但是如果想做到一个完善的秒杀系统却可能投入大量资源（研发和运行），因此需要慎重考虑。以下几点是在开发秒杀系统中值得考虑的。
1. 开发是渐进的。最初的版本可能是不那么高可用和高性能的，比如下单后可以直接将订单放入MQ中，订单系统直接操作数据库减库存，而不是缓存系统。随着业务加大秒杀宣称和引流的力度，再完善下单流程以及风险模块和运营指标收集系统。但是最初版本中应该完成详情页的动静分离以及CDN的使用，这是因为这是一个重要的基础支撑功能，同样提升主站的用户体验和可用性。
2. 围绕云部署和便捷的云资源高伸缩性，建立灵活的云资源运维体系。这样可以应对突发流量的导入以及大幅降低投入资源的成本（精确的资源伸缩，准确控制成本）。
3. 也是最重要的一点，从运营角度看，这是一个基于ROI（投入产出比）的平衡。投入的成本，是可以计算的：投入成本=研发成本+秒杀活动中云服务的成本+秒杀卖出商品的成本。研发成本主要是迭代周期中投入的人员和相关资源的成本；因为秒杀系统是相对独立的，如带宽，计算资源和存储资源，所以在迭代周期中每次秒杀活动的云服务（比如增加20台ECS使用24小时等）的总成本是可以将各云服务成本加总即可。产出是需要通过运营指标收集系统收集的相关指标计算的。这里有两点需要说明：（1）正如前面所说，秒杀的产出并不是交易的订单的收入（因为订单数量有限，而且利润为负或极低）。需要和其他指标一起看达成的成果，比如引流100万人浏览商品，增加1万新用户，消耗10万用户的积分等等。(2)秒杀活动的目标并不是每次都一样的，比如有的是为了增加新用户，有的是为了留存，有的是市场品牌宣传，因此每次活动如何比对产出效果是一个问题。可以有几种方法，一个是将所有指标向量化，然后和一组不同权重的系数相乘，然后进行归一化得到一个（0，1]区间的数，系数可以依据多次活动进行调整。这样就可以进行对比了。另一种方式就是，直接对主要目标，预先划分好区间，形成一个标量数组，将指标映射到标量数组的一个值，比如引流为目标，引流10万人是A，5万人是B，1万人是C。拉新为目标，新用户1万人是A，5千人是B，3千人是C。运营人员每次活动前先预估目标达成指标的情况，然后和运维人员商定资源预留即投入成本中资源的部分，同时计算出投入成本；活动中进行指标收集；活动后进行评估；进行相应调整，包括运营方式上，和研发功能上；进行下一次活动。基本是一个PDCA的闭环。
总结，仅从秒杀系统开发本身看，有很好的学习价值，可以很好地研究高并发高可用分布式系统的开发，但是从业务角度看大部分情况是战术手段，但是如果从提升系统可支撑性以及进化云环境下运维体系和持续完善运营手段角度看，秒杀的迭代渐进开发是一个很好的抓手。

参考：

百度百科的秒杀定义 https://baike.baidu.com/item/%E7%A7%92%E6%9D%80/5661061?fr=aladdin

极客时间-《如何设计一个秒杀系统》（许令波） https://time.geekbang.org/column/intro/127

极客时间-《Java进阶训练营》第二十八课 （秦金卫）https://u.geekbang.org/lesson/51?article=336212

极客时间-《左耳听风》第61课（陈皓）https://time.geekbang.org/column/article/7047


# 作业说明
## Week15 作业题目：
## 周四作业：
1.（必做）针对课上讲解的内容，自己动手设计一个高并发的秒杀系统，讲架构图， 设计文档等，提交到 GitHub。

【一】从业务层面看，秒杀是一种营销手段，就是网络卖家发布一些超低价格的商品，所有买家在同一时间网上抢购的一种销售方式。由于商品价格低廉，往往一上架就被抢购一空，有时只用一秒钟。单纯的秒杀系统在业务层面上并不是或者说很难成为一个有盈利空间的交易方式，而是作为引流、品牌宣传、用户留存为目标的手段。

【二】从技术层面看秒杀系统会面对的问题：高并发读，高并发写，有效请求少（通常会是数量级上的差别），比较容易发生短时间会消耗大量资源（带宽，计算资源等），此外还经常伴随机器人和人工手工刷单等不利于商家行为的发生。因此完善秒杀系统需要具备以下几个特性：高性能、高可用、数据一致性、系统资源相对独立、良好的资源伸缩性、有效的风险控制。

高性能：秒杀涉及大量的并发读和并发写，因此支持高并发访问这点非常关键。

高可用：面对大量用户同时使用的交易系统（虽然实际成交量很低），高可用是十分重要的特性，而且必须有兜底方案（限流、服务降级等）

数据一致性：秒杀中商品减库存的需要尽可能地保证数据一致性

系统资源相对独立：因为秒杀活动具有不确定性，而且可能在极短时间处理大量请求，如果系统资源有关联和耦合会对目前的系统产生冲击。

良好的资源伸缩性：有一点需要说明，目前的秒杀系统应该是云部署的，应对有计划产生爆发式请求是可以以较低代价的快速进行网络资源和计算资源的堆加，以及秒杀结束后灵活地释放不必要的资源。

有效的风控：因为刷单以及恶意抢购者的存在，风控是很有必要的。当然初期可能只是避免简单一个用户同时刷多单的行为，但是如果秒杀活动持续进行，就需要不断完善分控体系。

【三】架构。整体架构如下：

![秒杀系统架构](http://bolgimg.beijingyijikeji.com/img/second_kill_arch_1.jpg)

整体架构，从左向右分别对应了在运营人员添加秒杀商品、秒杀前用户获取秒杀详情页、用户登录、秒杀下单以及支付和秒杀后运营获取秒杀结果进行分析的五个步骤。

运营人员通过秒杀商品后台管理系统添加商品并上架后，会直接将商品信息保存数据库中（上架只是修改了状态），同时在库存缓存中设置了初始库存，并且生成相应的静态页面存放到静态页面的缓存中，页面静态资源保存到OSS中。而在外网的CDN系统设置了相应的回源信息，这样可以进一步将静态页面和资源发布到CDN中。这里需要说明页面和库存缓存系统都是以Redis主从方式的，数据库同样采用了主从方式。

秒杀前用户获取秒杀详情页，直接从CDN中获取，这样将请求流量分散到CDN上，减轻了中央主站系统。此外，秒杀系统应该采用一个和主站不同的子域名，最好独立使用一个入口IP，这样进入流量和主站流量做区隔。如果初始和主站使用同一线路，则应限制秒杀系统域码访问带宽。

用户登录，访问用户系统进行用户登录。

秒杀页面中包含一个倒计时组件，倒计时结束后，进入秒杀请求页面，用户下单。这里可以设置一个验证环节，防止机器人刷单和降低用户的请求密度。如果但是用户体验可以设置一个特性开关，供线上灵活使用。用户下单的请求会通过一个验证模块，这个模块会快速过滤掉疑似机器人下单（明显低于验证环节用时）和同一用户多次下单（使用类似roaringbitmap的技术）以及将来自黑名单中IP和用户过滤掉。对于库存已为零后的请求也放弃，并回复给用户库存不足的信息。通过过滤模块的订单会推送到消息中间件（MQ）中，这里应使用二代的MQ，可以对消息进行堆积。秒杀订单系统从MQ中获取订单信息并进行减库存等操作，操作成功的订单会保存到订单数据库中并调用支付系统，订单系统会将所有处理的订单消息再退回到MQ中并且和之前的下单信息相关联。通知模块会获取相关信息（这里也包括支付系统推送到MQ中的信息），通知给用户。通知模块会将相关指标发生给数据收集系统。此外数据收集系统也会从APM、MQ和其他相关系统或模块获取（接收）相关信息，并且将和风险模块相关的信息发给风险模块，将运营数据发给运营指标收集系统。风险模块可以通过分析甄别初恶意用户或有风险的IP将其纳入黑名单。注：在左耳听风的专栏中提到可以通过CDN的边缘节点实现部分订单过滤方式。

秒杀后运营获取秒杀结果进行分析，运营人员通过运营指标收集系统分析秒杀活动的具体指标完成情况，以确认达成情况，作为复盘的参照事实和下次改进的依据。



参考：

百度百科的秒杀定义 https://baike.baidu.com/item/%E7%A7%92%E6%9D%80/5661061?fr=aladdin

极客时间-《如何设计一个秒杀系统》（许令波） https://time.geekbang.org/column/intro/127

极客时间-《Java进阶训练营》第二十八课 （秦金卫）https://u.geekbang.org/lesson/51?article=336212

极客时间-《左耳听风》第61课（陈皓）https://time.geekbang.org/column/article/7047

